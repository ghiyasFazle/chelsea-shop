{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard | Chelsea Shop{% endblock title %}

{% block content %}

<div class="flex justify-center items-center gap-4 my-8">
  <button id="filter-all" class="btn btn-light">All Products</button>
  <button id="filter-my" class="btn btn-light">My Products</button>

</div>


{% if user.is_authenticated %}
  <div class="text-center text-sm text-white font-semibold mb-4">
    {% if user.last_login %}
      Last login: {{ user.last_login|date:"d M Y, H:i" }}
    {% else %}
      Last login: Never
    {% endif %}
  </div>
{% endif %}


<div class="w-full border-t border-gray-200 mb-4"></div>

{# include reusable modal so showProductModal/hideProductModal are available #}
{% include 'modal.html' %}
{% include 'confirm_modal.html' %}


<style>
  .hidden { display: none !important; }
  .state-container { padding: 1rem; text-align: center; }
</style>

<div id="loading" class="state-container hidden">
  <p>Loading productsâ€¦</p>
</div>

<div id="error" class="state-container hidden">
  <p class="text-red-600">Something went wrong while fetching products.</p>
  <button id="retry-btn" class="btn btn-primary">Retry</button>
</div>

<div id="empty" class="state-container hidden">
  <img src="{% static 'images/no-product.png' %}" alt="No Products Found" style="max-width:200px; margin:0 auto;">
  <h3>Anda Belum Memiliki Product</h3>
  <p>Silahkan menambahkan product anda ke dalam toko.</p>
  <p><a href="{% url 'main:create_product' %}" class="btn btn-primary">Add Product</a></p>
</div>

<div id="grid" class="hidden">
  <div id="grid-inner" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 p-6">
  </div>
</div>

<template id="ssr-products">
{% if product_list %}
  {% for product in product_list %}
    {% include 'product_card.html' %}
  {% endfor %}
{% endif %}
</template>

<script>
  (function(){
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const empty = document.getElementById('empty');
    const grid = document.getElementById('grid');
    const gridInner = document.getElementById('grid-inner');
    const retryBtn = document.getElementById('retry-btn');

    function show(which){
      [loading, error, empty, grid].forEach(el => el.classList.add('hidden'));
      if(which) which.classList.remove('hidden');
    }

    async function fetchProducts(options = {}){
      const filter = options.filter || null;
      let url = '{% url "main:show_json" %}';
      if(filter) url += '?filter=' + encodeURIComponent(filter);
      show(loading);
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error('Network response was not ok');
        const data = await res.json();
        if(!data || data.length === 0){
          show(empty);
          return;
        }

        const fmt = new Intl.NumberFormat('id-ID');
        gridInner.innerHTML = '';
        data.forEach(item => {
          try {

            let obj, pk;
            if(item && typeof item === 'object' && 'fields' in item && 'pk' in item){
              obj = item.fields;
              pk = item.pk;
            } else if(item && typeof item === 'object' && ('pk' in item || 'id' in item) && ('name' in item || 'title' in item)){
              obj = item;
              pk = item.pk ?? item.id;
            } else {
              console.warn('Skipping unexpected item format', item);
              return;
            }

            const card = document.createElement('div');
            card.className = 'product-card';

            const thumb = (obj && obj.thumbnail) ? obj.thumbnail : '';
            const imgHtml = thumb ? `<div class="flex justify-center"><img src="${thumb}" alt="${escapeHtml(obj.name||'')}" class="product-image"></div>` : '';

            const name = obj && obj.name ? obj.name : (obj && obj.title ? obj.title : 'No name');
            const stock = obj && (obj.stock !== undefined) ? obj.stock : '-';
            const price = obj && (obj.price !== undefined) ? obj.price : 0;
            const desc = obj && obj.description ? obj.description : '';

            card.innerHTML = `
              <div class="product-header">
                <h3>${escapeHtml(name)}</h3>
                <span class="product-badge stock-badge">Stock: ${escapeHtml(stock)}</span>
                <span class="product-badge price-badge">Rp ${fmt.format(price)}</span>
              </div>
              ${imgHtml}
              <div class="product-desc">${escapeHtml(truncateWords(desc,25))}</div>
              <div class="product-buttons">
                <a href="${detailUrl(pk)}" class="read-more">Read More</a>
                <button type="button" class="edit-btn edit-trigger" data-id="${pk}">Edit Product</button>
                <button type="button" class="delete-btn delete-trigger" data-id="${pk}">Delete Product</button>
              </div>
            `;

            gridInner.appendChild(card);
          } catch (e) {
            console.error('Error rendering item', e, item);
          }
        });

        show(grid);

      }catch(err){
        console.error(err);
        const errNode = document.getElementById('error');
        if(errNode){
          errNode.innerHTML = `<p class="text-red-600">${escapeHtml(err.message)}</p><button id="retry-btn" class="btn btn-primary">Retry</button>`;
          document.getElementById('retry-btn').addEventListener('click', () => fetchProducts(options));
        }
        show(error);
      }
    }

  
    function escapeHtml(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function truncateWords(text, count){
      if(!text) return '';
      const words = text.split(/\s+/).slice(0, count);
      return words.join(' ') + (text.split(/\s+/).length>count ? '...' : '');
    }

    function detailUrl(pk){ return `/product/${pk}/`; }
    function editUrl(pk){ return `/product/${pk}/edit/`; }
    function deleteUrl(pk){ return `/product/${pk}/delete`; }

    retryBtn && retryBtn.addEventListener('click', fetchProducts);


    document.addEventListener('DOMContentLoaded', function(){
      const ssr = document.getElementById('ssr-products');
      if(ssr && ssr.content && ssr.content.children.length>0){
        gridInner.append(...Array.from(ssr.content.children));
        show(grid);
      }
      const btnAll = document.getElementById('filter-all');
      const btnMy = document.getElementById('filter-my');
      btnAll && btnAll.addEventListener('click', function(){ fetchProducts({filter: 'all'}); });
      btnMy && btnMy.addEventListener('click', function(){ fetchProducts({filter: 'my'}); });
      fetchProducts({filter: 'all'});


  document.addEventListener('refreshProducts', function(){ fetchProducts({filter: 'all'}); });

      document.addEventListener('openProductModal', function(){
        window.showProductModal && window.showProductModal('create', null);
      });

      
      const addBtn = document.getElementById('openCreateModal') || document.getElementById('add-product-btn');
      addBtn && addBtn.addEventListener('click', function(){
        window.showProductModal && window.showProductModal('create', null);
      });

     
      document.addEventListener('click', async function(e){
        const btn = e.target.closest && e.target.closest('.edit-trigger');
        if(!btn) return;
        const id = btn.dataset.id;
        if(!id) return;
        try{
          const res = await fetch(`/json/${encodeURIComponent(id)}/`, { headers: { 'Accept': 'application/json' } });
          if(!res.ok) throw new Error('Failed to fetch product');
          const data = await res.json();
          
          window.showProductModal && window.showProductModal('edit', data);
        }catch(err){
          console.error(err);
          alert('Gagal memuat data produk untuk diedit');
        }
      });

      document.addEventListener('click', async function(e){
        const dbtn = e.target.closest && e.target.closest('.delete-trigger');
        if(!dbtn) return;
        const id = dbtn.dataset.id;
        if(!id) return;

        try{
          const confirmed = await window.showConfirmModal('Hapus produk ini? Tindakan ini tidak bisa dibatalkan.');
          if(!confirmed) return;


          function getCookie(name){
            const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return v ? v.pop() : '';
          }


          window.setConfirmLoading && window.setConfirmLoading(true);
          try{
            const res = await fetch(`/product/${encodeURIComponent(id)}/delete`, {
              method: 'POST',
              headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
              }
            });

            if(!res.ok) throw new Error('Delete failed');


            fetchProducts({filter: 'all'});
          }finally{
            window.setConfirmLoading && window.setConfirmLoading(false);
          }
        }catch(err){
          console.error(err);
          alert('Gagal menghapus produk');
        }
      });


      document.addEventListener('productModalSubmit', async function(ev){
        const payload = ev.detail || {};

        function getCookie(name){
          const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
          return v ? v.pop() : '';
        }

        const csrftoken = getCookie('csrftoken');
        const isEdit = !!payload.id;
        const url = isEdit ? `/product/${payload.id}/edit/` : '{% url "main:create_product" %}';

        const body = new URLSearchParams();
        if(payload.name) body.append('name', payload.name);
        if(payload.description) body.append('description', payload.description);
        if(payload.price !== undefined) body.append('price', payload.price);
        if(payload.stock !== undefined) body.append('stock', payload.stock);
        if(payload.category) body.append('category', payload.category);
        if(payload.thumbnail) body.append('thumbnail', payload.thumbnail);

        if(payload.is_sale) body.append('is_sale', 'on');
        try{
          window.setModalSaving && window.setModalSaving(true);
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
              'X-CSRFToken': csrftoken,
              'X-Requested-With': 'XMLHttpRequest',
              'Accept': 'application/json'
            },
            body: body.toString()
          });

          const json = await res.json().catch(()=>null);

          if(!res.ok){
            if(res.status === 400 && json && json.errors){
              window.renderModalErrors && window.renderModalErrors(json.errors);
              return;
            }
            throw new Error('Server returned ' + res.status);
          }

          window.hideProductModal && window.hideProductModal();
          try{
            if(isEdit){
              showToast && showToast('Product updated', 'success');
            } else if(json && json.product && json.product.name){
              showToast && showToast('Product created: ' + json.product.name, 'success');
            } else {
              showToast && showToast('Product saved', 'success');
            }
          }catch(e){}
          fetchProducts({filter: 'all'});
        }catch(err){
          console.error('Error submitting product modal', err);
          alert('Gagal menyimpan produk: ' + err.message);
        }finally{
          window.setModalSaving && window.setModalSaving(false);
        }
      });
    });
  })();
</script>

{% endblock %}